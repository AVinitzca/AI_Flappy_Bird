<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>AI Flappy Bird</title>
		<style>
			* { padding: 0; margin: 0; }
			canvas { background: #eee; display: block; margin: 0 auto; }
		</style>		
	</head>
<body>

<canvas id="canvas" width="576" height="1024"></canvas>

<script>
	var canvas = document.getElementById("canvas");
	var context = canvas.getContext("2d");
	
	var imgPath = 'img/';
	
	context.imageSmoothingEnabled = false;
	
	
	var flappyBird = new FlappyBird();
	var background = new Background();
	var wall = new Wall(10.0);
	
	var delta = 0.0;
	var last = 0.0;
	
	function loop(timestamp) 
	{	
		delta = timestamp - last;
		last = timestamp;		
		
		update(delta);
		
		draw();
		
		// Redraw
		requestAnimationFrame(loop);
	}
	
	function update(elapsedTime)
	{
		flappyBird.update(elapsedTime);
		background.update(elapsedTime);
	}
			
	function draw()
	{	
	
		context.setTransform(1,0,0,1,0,0);
	
		// Clear the screen
		context.clearRect(0, 0, canvas.width, canvas.height);
			
		context.translate(-flappyBird.x, 0);
				
		background.draw(context);
		
		flappyBird.draw(context);	
		
		wall.draw(context);
		
		
	}
	
	
	canvas.addEventListener("click", function( event ) {
		flappyBird.flap();
	}, false);
  
	function FlappyBird()
	{		
		var flappyBirdImage = new Image();
		flappyBirdImage.src = imgPath + 'bird.png';	
		this.sprite = new Sprite(flappyBirdImage, 85, 60);
		
		this.x = 0.0;
		this.y = canvas.height / 2.0;
		this.angle = 0.0;
		this.speedX = 2.0;
		
		this.speedY = -5.0;
		this.velocityY = this.speedY;
		this.accelerationY = 0.078;
	}
	
	FlappyBird.prototype.update = function(elapsedTime)
	{	
		this.x += this.speedX;		
		this.y += this.velocityY;		
		this.velocityY += this.accelerationY;
		
		this.angle = this.velocityY * 0.1;
	}
	
	FlappyBird.prototype.flap = function()
	{
		flappyBird.velocityY = flappyBird.speedY;
	}
	
	FlappyBird.prototype.draw = function(context)
	{
		this.sprite.draw(context, this.x + 50.0, this.y, this.angle);
	}
	
	
	function OrientedBoundingBox(x, y, width, height, angle)
	{
		this.halfWidth = width * 0.5;
		this.halfHeight = height * 0.5;
		
		this.x = x;
		this.y = y;
		
		this.angle = angle;
	}
	
	OrientedBoundingBox.prototype.calculatePoints = function()	
	{
		var top = y + this.halfWidth;
		var bottom = y - this.halfWidth;
		var right = x + this.halfWidth;
		var left = x - this.halfWidth;
		this.points = 
		[
			[top, left],
			[top, right],
			[bottom, left],
			[bottom, right],
		];
	}
	
	OrientedBoundingBox.prototype.rotate = function()	
	{
		var cosA = cos(this.angle);
		var sinA = sin(this.angle);
		
		this.points.forEach(function(point)
		{
			point[0] = point[0] * cosA - point[1] * sinA;
			point[1] = point[0] * sinA + point[1] * cosA;
		});		
	}
	
	OrientedBoundingBox.prototype.update = function(x, y, angle)	
	{
		this.angle = angle;
		this.calculatePoints();
		this.rotate();
	}
	
	OrientedBoundingBox.prototype.collidesWith = function(aabb)			
	{
		for (var point in this.points)
		{
			if(point[0] > aabb.min[0] && point[1] > aabb.min[0] && point[1] < aabb.max[0] && point[1] < aabb.max[1])
				return true;
		}
		return false;
	}
	
	
	function AxisAlignedBoundingBox(x, y, width, height)
	{
		var halfWidth = width * 0.5;
		var halfHeight = height * 0.5;
		this.min = [x - halfWidth, y - halfHeight];
		this.max = [x + halfWidth, y + halfHeight];
	}
	
	
	
	
	function Wall(height)
	{
		if(Wall.topSprite == undefined)
		{
			var pipeTopImage = new Image();
			pipeTopImage.src = imgPath +  'pipetop.png';
			Wall.topSprite = new Sprite(pipeTopImage, pipeTopImage.width, pipeTopImage.height);
			
			pipeLengthImage = new Image();
			pipeLengthImage.src = imgPath + 'pipelength.png';
			Wall.lengthSprite = new Sprite(pipeLengthImage, pipeLengthImage.width, pipeLengthImage.height);			
		}
		
		this.x = 100.0;
		this.y = 100.0;
		this.angle = 0.0;
	}
		
	Wall.prototype.draw = function(context)
	{
		Wall.topSprite.draw(context, this.x, this.y);
		Wall.lengthSprite.draw(context, this.x, this.y);
	}
	
	
	
	
	
	
	
	
	function Background()
	{
		var backgroundImage = new Image();
		backgroundImage.src = imgPath + 'background.png';	
		this.sprite = new Sprite(backgroundImage, canvas.width, canvas.height);
		
		this.x = 0.0;
		this.y = canvas.height / 2.0;
		this.angle = 0.0;	
	}
	
	Background.prototype.update = function()
	{
		this.x = flappyBird.x + canvas.width * 0.5;
	}
	
	Background.prototype.draw = function(context)
	{
		this.sprite.draw(context, this.x, this.y, this.angle);
	}
	
	
	function Sprite(image, width, height)
	{
		this.image = image;
		this.width = width;
		this.height = height;
		this.halfWidth = width * 0.5;
		this.halfHeight = height * 0.5;
	}	
		
	Sprite.prototype.draw = function(context, x, y, angle)
	{
		context.save();
		context.translate(x, y);
		context.rotate(angle);
		context.drawImage(this.image, -this.halfWidth, -this.halfHeight, this.width, this.height);
		context.restore();		
	};	
		
	
	loop();
</script>

</body>
</html>